<!DOCTYPE html>
<html>
<head>
    <title>Color Calibrator</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 20px;
            background: #faf9f7;
        }
        h1 { margin: 0 0 10px 0; font-size: 1.3em; }
        .controls {
            display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .control-group {
            background: #fff; padding: 12px; border-radius: 6px;
            border: 1px solid #ddd;
        }
        .control-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; }
        input[type="range"] { width: 200px; }
        .value { font-family: monospace; font-size: 12px; color: #666; }

        .bar-container {
            background: #1a1a1a;
            padding: 40px 30px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .bar-wrapper {
            position: relative;
            margin: 50px 0;
        }
        .bar {
            position: relative;
            height: 20px;
            background: #e5e5e5;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .bar-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 5px;
            transition: width 0.1s;
        }

        .reticle {
            position: absolute;
            width: 2px;
            height: 100%;
            top: 0;
            cursor: ew-resize;
            z-index: 10;
        }
        .reticle.usage { background: #3b82f6; }
        .reticle.usage::after {
            content: '';
            position: absolute;
            left: -4px;
            bottom: -6px;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 6px solid #3b82f6;
        }
        .reticle.delta::before {
            content: '';
            position: absolute;
            left: -4px;
            top: -6px;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }

        .label {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            cursor: ew-resize;
        }
        .label.usage {
            bottom: -28px;
            background: #3b82f6;
            color: #fff;
        }
        .label.delta {
            top: -28px;
            color: #fff;
            border: 1px solid #000;
        }

        .overlay {
            position: absolute;
            height: 100%;
            top: 0;
            border-radius: 5px;
            pointer-events: none;
        }
        .glow {
            position: absolute;
            height: 100%;
            top: 0;
            border-radius: 5px;
            pointer-events: none;
        }

        .info {
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.8;
        }
        .info strong { color: #333; }

        .outline-options {
            display: flex; gap: 10px; margin-top: 8px;
        }
        .outline-options label {
            font-weight: normal;
            font-size: 12px;
            cursor: pointer;
        }

        .bar-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>Color Calibrator - Drag reticles to test colors</h1>

    <div class="controls">
        <div class="control-group">
            <label>Usage Position (blue)</label>
            <input type="range" id="usage-slider" min="0" max="100" value="75">
            <span class="value" id="usage-value">75%</span>
        </div>
        <div class="control-group">
            <label>NOW Position (delta)</label>
            <input type="range" id="now-slider" min="0" max="100" value="55">
            <span class="value" id="now-value">55%</span>
        </div>
        <div class="control-group">
            <label>RED Floor (OVER)</label>
            <input type="range" id="red-floor-slider" min="0" max="50" value="35">
            <span class="value" id="red-floor-value">35%</span>
        </div>
        <div class="control-group">
            <label>RED Speed (2x = twice as fast)</label>
            <input type="range" id="red-speed-slider" min="1" max="4" step="0.5" value="2">
            <span class="value" id="red-speed-value">2x</span>
        </div>
        <div class="control-group">
            <label>GREEN Floor (UNDER)</label>
            <input type="range" id="green-floor-slider" min="0" max="50" value="35">
            <span class="value" id="green-floor-value">35%</span>
        </div>
        <div class="control-group">
            <label>GREEN Speed</label>
            <input type="range" id="green-speed-slider" min="1" max="4" step="0.5" value="2">
            <span class="value" id="green-speed-value">2x</span>
        </div>
        <div class="control-group">
            <label>Text Outline Style</label>
            <div class="outline-options">
                <label><input type="radio" name="outline" value="heavy"> Heavy (current)</label>
                <label><input type="radio" name="outline" value="soft" checked> Soft shadow</label>
                <label><input type="radio" name="outline" value="thin"> Thin outline</label>
                <label><input type="radio" name="outline" value="none"> None</label>
            </div>
        </div>
    </div>

    <div class="bar-container">
        <div class="bar-label">Drag the reticles or use sliders above</div>
        <div class="bar-wrapper">
            <div class="bar" id="bar">
                <div class="bar-fill" id="bar-fill"></div>
                <div class="glow" id="glow"></div>
                <div class="overlay" id="overlay"></div>
                <div class="reticle delta" id="delta-reticle">
                    <div class="label delta" id="delta-label">0h UNDER</div>
                </div>
                <div class="reticle usage" id="usage-reticle">
                    <div class="label usage" id="usage-label">Thu 5PM</div>
                </div>
            </div>
        </div>
    </div>

    <div class="info" id="info">
        Loading...
    </div>

    <script>
        const bar = document.getElementById('bar');
        const barFill = document.getElementById('bar-fill');
        const glow = document.getElementById('glow');
        const overlay = document.getElementById('overlay');
        const deltaReticle = document.getElementById('delta-reticle');
        const usageReticle = document.getElementById('usage-reticle');
        const deltaLabel = document.getElementById('delta-label');
        const usageLabel = document.getElementById('usage-label');
        const usageSlider = document.getElementById('usage-slider');
        const nowSlider = document.getElementById('now-slider');
        const redFloorSlider = document.getElementById('red-floor-slider');
        const redSpeedSlider = document.getElementById('red-speed-slider');
        const greenFloorSlider = document.getElementById('green-floor-slider');
        const greenSpeedSlider = document.getElementById('green-speed-slider');
        const usageValue = document.getElementById('usage-value');
        const nowValue = document.getElementById('now-value');
        const redFloorValue = document.getElementById('red-floor-value');
        const redSpeedValue = document.getElementById('red-speed-value');
        const greenFloorValue = document.getElementById('green-floor-value');
        const greenSpeedValue = document.getElementById('green-speed-value');
        const info = document.getElementById('info');

        let usagePos = 75;
        let nowPos = 55;
        let redFloor = 0.35;
        let redSpeed = 2;
        let greenFloor = 0.35;
        let greenSpeed = 2;
        let outlineStyle = 'soft';

        function getColor(pct) {
            if (pct < 0) {
                // Green for under budget - dramatic like red
                const rawP = Math.min(Math.abs(pct) / 100 * greenSpeed, 1);
                const p = greenFloor + (1 - greenFloor) * rawP;
                const sat = 5 + p * 70;  // 5% → 75% (was 40 → 70)
                const lit = 95 - p * 55; // 95% → 40% (was 50 → 40)
                return `hsl(142, ${sat}%, ${lit}%)`;
            } else {
                // Red for over budget
                const rawP = Math.min(Math.abs(pct) / 100 * redSpeed, 1);
                const p = redFloor + (1 - redFloor) * rawP;
                const sat = 5 + p * 75;
                const lit = 95 - p * 55;
                return `hsl(0, ${sat}%, ${lit}%)`;
            }
        }

        function getIntensity(pct) {
            if (pct < 0) {
                const rawP = Math.min(Math.abs(pct) / 100 * greenSpeed, 1);
                return greenFloor + (1 - greenFloor) * rawP;
            } else {
                const rawP = Math.min(Math.abs(pct) / 100 * redSpeed, 1);
                return redFloor + (1 - redFloor) * rawP;
            }
        }

        function getRawIntensity(pct) {
            if (pct < 0) {
                return Math.min(Math.abs(pct) / 100 * greenSpeed, 1);
            } else {
                return Math.min(Math.abs(pct) / 100 * redSpeed, 1);
            }
        }

        function fmtDelta(pct) {
            const hrs = Math.abs(pct / 100 * 168); // 168 hours in a week
            const d = Math.floor(hrs / 24);
            const h = Math.floor(hrs % 24);
            const m = Math.round((hrs - Math.floor(hrs)) * 60);
            let t = '';
            if (d > 0) t = d + 'd ' + h + 'h';
            else if (h > 0) t = h + 'h' + (m > 0 ? ' ' + m + 'm' : '');
            else t = m + 'm';
            return t + ' ' + (pct >= 0 ? 'OVER' : 'UNDER');
        }

        function getOutlineCSS() {
            switch (outlineStyle) {
                case 'heavy':
                    return 'text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;';
                case 'soft':
                    return 'text-shadow: 0 1px 2px rgba(0,0,0,0.9), 0 0 4px rgba(0,0,0,0.7), 0 0 8px rgba(0,0,0,0.4);';
                case 'thin':
                    return 'text-shadow: -0.5px -0.5px 0 #000, 0.5px -0.5px 0 #000, -0.5px 0.5px 0 #000, 0.5px 0.5px 0 #000;';
                case 'none':
                    return 'text-shadow: none;';
            }
        }

        function update() {
            const diffPct = usagePos - nowPos;
            const rawIntensity = getRawIntensity(diffPct);
            const intensity = getIntensity(diffPct);
            const color = getColor(diffPct);
            const isOver = diffPct >= 0;
            const floor = isOver ? redFloor : greenFloor;
            const speed = isOver ? redSpeed : greenSpeed;

            // Update bar fill
            barFill.style.width = usagePos + '%';

            // Update reticle positions
            usageReticle.style.left = usagePos + '%';
            deltaReticle.style.left = nowPos + '%';
            deltaReticle.style.background = color;

            // Update arrow color
            deltaReticle.style.setProperty('--arrow-color', color);
            const arrowStyle = `border-top: 6px solid ${color}`;
            deltaReticle.querySelector('::before')?.style;
            // Inject dynamic arrow color
            document.getElementById('dynamic-style')?.remove();
            const style = document.createElement('style');
            style.id = 'dynamic-style';
            style.textContent = `.reticle.delta::before { border-top: 6px solid ${color}; }`;
            document.head.appendChild(style);

            // Update labels
            deltaLabel.style.background = color;
            deltaLabel.textContent = fmtDelta(diffPct);
            deltaLabel.style.cssText = `
                top: -28px;
                background: ${color};
                color: #fff;
                border: 1px solid #000;
                ${getOutlineCSS()}
            `;

            // Update overlay/glow
            glow.style.display = 'none';
            overlay.style.display = 'none';

            if (diffPct > 0) {
                // Over budget - red glow + overlay
                glow.style.display = 'block';
                glow.style.left = nowPos + '%';
                glow.style.width = Math.abs(diffPct) + '%';
                glow.style.boxShadow = `0 0 ${8 + intensity * 15}px ${2 + intensity * 5}px hsla(0, ${50 + intensity * 30}%, ${50 - intensity * 10}%, ${0.4 + intensity * 0.4})`;

                overlay.style.display = 'block';
                overlay.style.left = nowPos + '%';
                overlay.style.width = Math.abs(diffPct) + '%';
                overlay.style.background = `hsla(0, ${60 + intensity * 20}%, ${40 - intensity * 10}%, ${0.55 + intensity * 0.25})`;
            } else if (diffPct < 0) {
                // Under budget - green overlay
                overlay.style.display = 'block';
                overlay.style.left = usagePos + '%';
                overlay.style.width = Math.abs(diffPct) + '%';
                overlay.style.background = `hsla(142, ${40 + intensity * 30}%, ${50 - intensity * 10}%, ${0.4 + intensity * 0.35})`;
            }

            // Update sliders
            usageSlider.value = usagePos;
            nowSlider.value = nowPos;
            redFloorSlider.value = redFloor * 100;
            redSpeedSlider.value = redSpeed;
            greenFloorSlider.value = greenFloor * 100;
            greenSpeedSlider.value = greenSpeed;
            usageValue.textContent = usagePos.toFixed(0) + '%';
            nowValue.textContent = nowPos.toFixed(0) + '%';
            redFloorValue.textContent = (redFloor * 100).toFixed(0) + '%';
            redSpeedValue.textContent = redSpeed + 'x';
            greenFloorValue.textContent = (greenFloor * 100).toFixed(0) + '%';
            greenSpeedValue.textContent = greenSpeed + 'x';

            // Update info
            info.innerHTML = `
<strong>Diff:</strong> ${diffPct.toFixed(1)}% (${isOver ? 'OVER' : 'UNDER'} budget)
<strong>Mode:</strong> ${isOver ? 'RED (floor=' + (redFloor*100).toFixed(0) + '%, speed=' + redSpeed + 'x)' : 'GREEN (floor=' + (greenFloor*100).toFixed(0) + '%, speed=' + greenSpeed + 'x)'}
<strong>Raw intensity (with speed):</strong> ${(rawIntensity * 100).toFixed(0)}%
<strong>Final intensity (with floor):</strong> ${(intensity * 100).toFixed(0)}%
<strong>Color:</strong> ${color}
<strong>Hours diff:</strong> ${(Math.abs(diffPct) / 100 * 168).toFixed(1)}h (weekly) / ${(Math.abs(diffPct) / 100 * 5).toFixed(2)}h (session)

<strong>Intensity formula:</strong> p = floor + (1 - floor) * min(diff/100 * speed, 1)
  = ${floor.toFixed(2)} + ${(1-floor).toFixed(2)} * ${rawIntensity.toFixed(2)} = ${intensity.toFixed(2)}

<strong>Color formula (${isOver ? 'RED' : 'GREEN'}):</strong>
${isOver ?
    `sat = 5 + p * 75 = ${(5 + intensity * 75).toFixed(0)}%
lit = 95 - p * 55 = ${(95 - intensity * 55).toFixed(0)}%` :
    `sat = 5 + p * 70 = ${(5 + intensity * 70).toFixed(0)}%
lit = 95 - p * 55 = ${(95 - intensity * 55).toFixed(0)}%`
}
            `;
        }

        // Slider handlers
        usageSlider.addEventListener('input', (e) => {
            usagePos = parseFloat(e.target.value);
            update();
        });
        nowSlider.addEventListener('input', (e) => {
            nowPos = parseFloat(e.target.value);
            update();
        });
        redFloorSlider.addEventListener('input', (e) => {
            redFloor = parseFloat(e.target.value) / 100;
            update();
        });
        redSpeedSlider.addEventListener('input', (e) => {
            redSpeed = parseFloat(e.target.value);
            update();
        });
        greenFloorSlider.addEventListener('input', (e) => {
            greenFloor = parseFloat(e.target.value) / 100;
            update();
        });
        greenSpeedSlider.addEventListener('input', (e) => {
            greenSpeed = parseFloat(e.target.value);
            update();
        });

        // Outline style handler
        document.querySelectorAll('input[name="outline"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                outlineStyle = e.target.value;
                update();
            });
        });

        // Drag handlers
        let dragging = null;

        function startDrag(which) {
            return (e) => {
                dragging = which;
                e.preventDefault();
            };
        }

        deltaReticle.addEventListener('mousedown', startDrag('now'));
        deltaLabel.addEventListener('mousedown', startDrag('now'));
        usageReticle.addEventListener('mousedown', startDrag('usage'));
        usageLabel.addEventListener('mousedown', startDrag('usage'));

        document.addEventListener('mousemove', (e) => {
            if (!dragging) return;
            const rect = bar.getBoundingClientRect();
            const pct = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
            if (dragging === 'usage') {
                usagePos = pct;
            } else {
                nowPos = pct;
            }
            update();
        });

        document.addEventListener('mouseup', () => {
            dragging = null;
        });

        // Initial render
        update();
    </script>
</body>
</html>
